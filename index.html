<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RM Enterprise Inventory System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for a more premium feel */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; /* Lighter, cleaner background */
        }
        .font-consolas {
            font-family: 'Inconsolata', monospace;
        }
        /* Gradient background for the login page */
        #login-section-container {
            background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%);
        }
        /* Modal styling */
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        
        /* Tab styling */
        .tab-active { border-color: #4338ca; color: #4338ca; }
        .tab-inactive { border-color: transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; }

        /* Table sticky header styling */
        .table-container { max-height: 60vh; overflow-y: auto; }
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8fafc;
        }
        .sticky-category-header th {
            position: sticky;
            top: 49px; /* Height of the main table header */
            z-index: 5;
        }

        /* Premium button styles with hover effect */
        .btn {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }

        /* Animation for the 'Add New Item' button */
        .pulse-animate {
            animation: pulse 2.5s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- App Container -->
    <div id="app">

        <!-- Login Section -->
        <div id="login-section" class="min-h-screen flex items-center justify-center" id="login-section-container">
            <div class="max-w-md w-full">
                <div id="login-card" class="bg-white p-8 rounded-xl shadow-2xl">
                    <h1 class="text-3xl font-bold text-center text-slate-800 mb-2 font-consolas">RM Enterprise Inventory System</h1>
                    <p class="text-center text-slate-500 mb-8">Sign in to manage your hardware shop</p>
                    <div id="auth-error" class="text-red-500 text-center mb-4 hidden"></div>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="email" class="block text-slate-700 text-sm font-bold mb-2">Email</label>
                            <input type="email" id="email" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-slate-700 text-sm font-bold mb-2">Password</label>
                            <input type="password" id="password" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-3 px-4 text-slate-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div class="flex items-center justify-between">
                            <button type="submit" id="login-btn" class="btn btn-primary font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline w-full">Sign In</button>
                        </div>
                        <p class="text-center text-sm text-slate-500 mt-6">Don't have an account? <a href="#" id="show-signup" class="font-medium text-indigo-600 hover:text-indigo-500">Sign Up</a></p>
                    </form>
                    <form id="signup-form" class="hidden">
                        <div class="mb-4"><label for="signup-email" class="block text-slate-700 text-sm font-bold mb-2">Email</label><input type="email" id="signup-email" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-3 px-4 text-slate-700" required></div>
                        <div class="mb-6"><label for="signup-password" class="block text-slate-700 text-sm font-bold mb-2">Password</label><input type="password" id="signup-password" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-3 px-4 text-slate-700" required></div>
                        <button type="submit" id="signup-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg w-full">Create Account</button>
                        <p class="text-center text-sm text-slate-500 mt-6">Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Sign In</a></p>
                    </form>
                </div>
            </div>
        </div>

        <!-- Main Content Section (Post-Login) -->
        <div id="main-content" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Header -->
            <header class="flex flex-wrap justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800 font-consolas">RM Enterprise Inventory System</h2>
                    <h1 class="text-4xl font-bold text-slate-600">Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <p id="user-info" class="text-sm text-slate-600 hidden md:block"></p>
                    <button id="logout-btn" class="btn bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition-colors">Logout</button>
                </div>
            </header>

            <!-- Tabs -->
            <div class="mb-6">
                <div class="border-b border-slate-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tab-inventory" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg tab-active">Inventory</button>
                        <button id="tab-reports" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg tab-inactive">Sales Reports</button>
                    </nav>
                </div>
            </div>

            <!-- Inventory View -->
            <div id="inventory-view">
                <!-- Dashboard Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-start space-x-4"><div class="bg-indigo-100 text-indigo-600 p-3 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg></div><div class="min-w-0"><h3 class="text-slate-500 text-sm font-medium">Total Stock Value</h3><p id="stat-total-value" class="text-3xl font-bold text-slate-800 mt-1 break-words">৳0.00</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-start space-x-4"><div class="bg-indigo-100 text-indigo-600 p-3 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg></div><div class="min-w-0"><h3 class="text-slate-500 text-sm font-medium">Total Items (SKUs)</h3><p id="stat-total-items" class="text-3xl font-bold text-slate-800 mt-1 break-words">0</p></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg flex items-start space-x-4"><div class="bg-indigo-100 text-indigo-600 p-3 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg></div><div class="min-w-0"><h3 class="text-slate-500 text-sm font-medium">Categories</h3><p id="stat-total-categories" class="text-3xl font-bold text-slate-800 mt-1 break-words">0</p></div></div>
                </div>

                <!-- Controls -->
                <div class="mb-4 flex flex-wrap gap-4 items-center">
                    <button id="add-item-btn" class="btn btn-primary font-bold py-2 px-4 rounded-lg shadow pulse-animate">Add New Item</button>
                    <div class="relative flex-grow sm:flex-grow-0 sm:w-64">
                        <select id="category-filter" class="w-full p-2 pl-4 pr-10 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="relative flex-grow">
                        <input type="text" id="search-input" placeholder="Search by name or SKU..." class="w-full p-2 pl-10 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <svg class="w-5 h-5 text-slate-400 absolute top-1/2 left-3 transform -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>
                <!-- Inventory Table -->
                <div class="bg-white shadow-lg rounded-xl">
                    <div class="table-container">
                        <table class="min-w-full leading-normal">
                            <thead class="sticky-header">
                                <tr>
                                    <th class="px-5 py-3 border-b-2 border-slate-200 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Item Name</th>
                                    <th class="px-5 py-3 border-b-2 border-slate-200 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SKU</th>
                                    <th class="px-5 py-3 border-b-2 border-slate-200 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Stock</th>
                                    <th class="px-5 py-3 border-b-2 border-slate-200 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Size</th>
                                    <th class="px-5 py-3 border-b-2 border-slate-200 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Price</th>
                                    <th class="px-5 py-3 border-b-2 border-slate-200 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body" class="divide-y divide-slate-200"></tbody>
                        </table>
                    </div>
                    <div id="loading-indicator" class="text-center p-8 text-slate-500">Loading inventory...</div>
                    <div id="no-items-message" class="text-center p-8 text-slate-500 hidden">No items in inventory.</div>
                </div>
            </div>

            <!-- Sales Report View -->
            <div id="reports-view" class="hidden">
                <div class="mb-4 flex flex-wrap gap-4 items-center bg-white p-4 rounded-xl shadow-md">
                    <div>
                        <label for="report-date" class="block text-sm font-medium text-slate-700">Select Date</label>
                        <input type="date" id="report-date" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    </div>
                    <button id="download-csv-btn" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow self-end">Download Report (CSV)</button>
                </div>
                <!-- Sales Report Table -->
                 <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <table class="min-w-full leading-normal">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-5 py-3 border-b-2 border-slate-200 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Time</th>
                                <th class="px-5 py-3 border-b-2 border-slate-200 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Item Name</th>
                                <th class="px-5 py-3 border-b-2 border-slate-200 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">SKU</th>
                                <th class="px-5 py-3 border-b-2 border-slate-200 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Qty Sold</th>
                                <th class="px-5 py-3 border-b-2 border-slate-200 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Total Price</th>
                                <th class="px-5 py-3 border-b-2 border-slate-200 text-center text-xs font-semibold text-slate-600 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="sales-report-body" class="divide-y divide-slate-200"></tbody>
                    </table>
                    <div id="report-loading" class="text-center p-8 text-slate-500 hidden">Loading report...</div>
                    <div id="no-sales-message" class="text-center p-8 text-slate-500 hidden">No sales recorded for this day.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="item-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-xl w-11/12 md:max-w-md mx-auto p-6 modal transform scale-95 opacity-0">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-slate-800">Add New Item</h2>
            <form id="item-form">
                <input type="hidden" id="item-id">
                <div class="mb-4"><label for="item-name" class="block text-slate-700 text-sm font-bold mb-2">Item Name</label><input type="text" id="item-name" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700" required></div>
                <div class="mb-4"><label for="item-category" class="block text-slate-700 text-sm font-bold mb-2">Category</label><input type="text" id="item-category" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700" placeholder="e.g., Power Tools" required></div>
                <div class="mb-4"><label for="item-sku" class="block text-slate-700 text-sm font-bold mb-2">SKU (auto-generated)</label><input type="text" id="item-sku" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 bg-slate-100" required></div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label for="item-quantity" class="block text-slate-700 text-sm font-bold mb-2">Quantity</label><input type="number" id="item-quantity" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700" required min="0"></div>
                    <div><label for="item-price" class="block text-slate-700 text-sm font-bold mb-2">Price (৳)</label><input type="number" id="item-price" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700" required min="0" step="0.01"></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><label for="item-size" class="block text-slate-700 text-sm font-bold mb-2">Size (Optional)</label><input type="number" id="item-size" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700" step="any"></div>
                    <div>
                        <label for="item-unit" class="block text-slate-700 text-sm font-bold mb-2">Unit</label>
                        <select id="item-unit" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700 bg-white">
                            <option value="">N/A</option>
                            <option value="inch">inch</option>
                            <option value="mm">mm</option>
                            <option value="cm">cm</option>
                            <option value="feet">feet</option>
                            <option value="meter">meter</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-btn" class="btn bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="btn btn-primary font-bold py-2 px-4 rounded-lg">Save Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Sell Item Modal -->
    <div id="sell-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-white rounded-xl shadow-xl w-11/12 md:max-w-sm mx-auto p-6 modal transform scale-95 opacity-0">
            <h2 id="sell-modal-title" class="text-2xl font-bold mb-4 text-slate-800">Sell Item</h2>
            <form id="sell-form">
                <input type="hidden" id="sell-item-id">
                <p class="mb-2 text-slate-600">Item: <strong id="sell-item-name" class="text-slate-800"></strong></p>
                <p class="mb-4 text-slate-600">In Stock: <strong id="sell-item-stock" class="text-slate-800"></strong></p>
                <div class="mb-4">
                    <label for="sell-quantity" class="block text-slate-700 text-sm font-bold mb-2">Quantity to Sell</label>
                    <input type="number" id="sell-quantity" class="shadow-sm appearance-none border border-slate-300 rounded-lg w-full py-2 px-3 text-slate-700" required min="1">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-sell-btn" class="btn bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Confirm Sale</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed bottom-5 right-5 bg-slate-800 text-white py-3 px-5 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300">
        <p id="notification-message"></p>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- Firebase Configuration ---
   const firebaseConfig = {
  apiKey: "AIzaSyCTyhpmv2ccM8OQIWaPJ2ZR7AKgDOGdZsc",
  authDomain: "rm-enterprise-inventory.firebaseapp.com",
  projectId: "rm-enterprise-inventory",
  storageBucket: "rm-enterprise-inventory.firebasestorage.app",
  messagingSenderId: "343379662698",
  appId: "1:343379662698:web:3cb825dcddd1aae0df3713"
};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, where, Timestamp, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        if (firebaseConfig.apiKey === "YOUR_API_KEY" && typeof __firebase_config === 'undefined') {
            const loginCard = document.getElementById('login-card');
            if(loginCard) {
                loginCard.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
                        <p class="font-bold">Configuration Error</p>
                        <p>Your Firebase configuration is missing. Please follow the setup steps to copy and paste your project's keys into the HTML file before deploying.</p>
                    </div>
                `;
            }
            throw new Error("Firebase config is not set. Please replace placeholder keys.");
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        // --- Global State ---
        let currentUserId = null;
        let inventoryCollectionRef = null;
        let salesCollectionRef = null;
        let unsubscribeInventoryListener = null;
        let allItems = [];
        let dailySales = [];

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const mainContent = document.getElementById('main-content');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const tabInventory = document.getElementById('tab-inventory');
        const tabReports = document.getElementById('tab-reports');
        const inventoryView = document.getElementById('inventory-view');
        const reportsView = document.getElementById('reports-view');
        const addItemBtn = document.getElementById('add-item-btn');
        const inventoryTableBody = document.getElementById('inventory-table-body');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');
        const loadingIndicator = document.getElementById('loading-indicator');
        const noItemsMessage = document.getElementById('no-items-message');
        
        // Dashboard Stats Elements
        const statTotalValue = document.getElementById('stat-total-value');
        const statTotalItems = document.getElementById('stat-total-items');
        const statTotalCategories = document.getElementById('stat-total-categories');

        // Notification Elements
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        let toastTimeout;
        
        // Report elements
        const reportDateInput = document.getElementById('report-date');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        const salesReportBody = document.getElementById('sales-report-body');
        const reportLoading = document.getElementById('report-loading');
        const noSalesMessage = document.getElementById('no-sales-message');

        // Modals
        const itemModal = document.getElementById('item-modal');
        const sellModal = document.getElementById('sell-modal');
        const itemForm = document.getElementById('item-form');
        const itemIdInput = document.getElementById('item-id');
        const itemCategoryInput = itemForm.querySelector('#item-category');
        const itemSkuInput = itemForm.querySelector('#item-sku');

        // --- UI Functions ---
        function showNotification(message, duration = 3000) {
            clearTimeout(toastTimeout);
            notificationMessage.textContent = message;
            notificationToast.classList.remove('translate-y-20', 'opacity-0');

            toastTimeout = setTimeout(() => {
                notificationToast.classList.add('translate-y-20', 'opacity-0');
            }, duration);
        }

        // --- Authentication Logic ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                inventoryCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/inventory`);
                salesCollectionRef = collection(db, `artifacts/${appId}/users/${currentUserId}/sales`);
                loginSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                userInfo.textContent = `Welcome, ${user.email}`;
                setupInventoryListener();
                reportDateInput.valueAsDate = new Date();
                fetchSalesReport();
            } else {
                // BUG FIX: Clear local data on logout
                currentUserId = null;
                allItems = [];
                dailySales = [];
                loginSection.classList.remove('hidden');
                mainContent.classList.add('hidden');
                if (unsubscribeInventoryListener) unsubscribeInventoryListener();
            }
        });
        
        (async () => {
             try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else if (!auth.currentUser) {
                    console.log("No user signed in. Awaiting login.");
                }
            } catch (error) {
                console.error("Error during initial auth:", error);
                await signInAnonymously(auth);
            }
        })();
        
        // --- Tab Navigation ---
        tabInventory.addEventListener('click', () => switchTab('inventory'));
        tabReports.addEventListener('click', () => switchTab('reports'));

        function switchTab(tabName) {
            if (tabName === 'inventory') {
                inventoryView.classList.remove('hidden');
                reportsView.classList.add('hidden');
                tabInventory.classList.replace('tab-inactive', 'tab-active');
                tabReports.classList.replace('tab-active', 'tab-inactive');
            } else {
                inventoryView.classList.add('hidden');
                reportsView.classList.remove('hidden');
                tabInventory.classList.replace('tab-active', 'tab-inactive');
                tabReports.classList.replace('tab-inactive', 'tab-active');
            }
        }

        // --- OPTIMIZED INVENTORY LOGIC ---
        function setupInventoryListener() {
            if (unsubscribeInventoryListener) unsubscribeInventoryListener();
            loadingIndicator.style.display = 'block';
            noItemsMessage.classList.add('hidden');

            const q = query(inventoryCollectionRef);
            unsubscribeInventoryListener = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const docData = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === "added") {
                        allItems.push(docData);
                    }
                    if (change.type === "modified") {
                        const index = allItems.findIndex(item => item.id === docData.id);
                        if (index > -1) {
                            allItems[index] = docData;
                        }
                    }
                    if (change.type === "removed") {
                        allItems = allItems.filter(item => item.id !== docData.id);
                    }
                });
                
                updateDashboardStats();
                renderInventory();
                populateCategoryFilter();
                loadingIndicator.style.display = 'none';
                noItemsMessage.classList.toggle('hidden', allItems.length > 0);

            }, (error) => {
                console.error("Error with inventory listener:", error);
                loadingIndicator.textContent = "Error loading data.";
            });
        }
        
        function updateDashboardStats() {
            const totalValue = allItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const categories = new Set(allItems.map(item => item.category));
            
            statTotalValue.textContent = `৳${totalValue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            statTotalItems.textContent = allItems.length;
            statTotalCategories.textContent = categories.size;
        }

        function renderInventory() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;

            const filteredItems = allItems.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) || item.sku.toLowerCase().includes(searchTerm);
                const matchesCategory = !selectedCategory || item.category === selectedCategory;
                return matchesSearch && matchesCategory;
            });

            const grouped = filteredItems.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});

            let html = '';
            const sortedCategories = Object.keys(grouped).sort();

            if (filteredItems.length === 0 && allItems.length > 0) {
                html = `<tr><td colspan="6" class="text-center p-8 text-slate-500">No items match your search or filter.</td></tr>`;
            } else {
                sortedCategories.forEach(category => {
                    const categorySafe = category.replace(/"/g, '&quot;');
                    html += `
                        <tr class="sticky-category-header">
                            <th colspan="6" class="px-5 py-2 text-left text-sm font-semibold text-slate-700 border-b-2 border-slate-300 bg-slate-100">
                                <div class="flex justify-between items-center">
                                    <span>${category}</span>
                                    <button data-category="${category === 'Uncategorized' ? '' : categorySafe}" class="add-to-category-btn bg-indigo-100 text-indigo-600 hover:bg-indigo-200 text-xs font-bold py-1 px-3 rounded-full flex items-center transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                        Add
                                    </button>
                                </div>
                            </th>
                        </tr>
                    `;
                    grouped[category].forEach(item => {
                        html += `
                            <tr class="hover:bg-slate-50">
                                <td class="px-5 py-4 bg-white text-sm"><p class="text-slate-900 whitespace-no-wrap font-medium">${item.name}</p></td>
                                <td class="px-5 py-4 bg-white text-sm"><p class="text-slate-600 whitespace-no-wrap">${item.sku}</p></td>
                                <td class="px-5 py-4 bg-white text-sm text-center"><span class="font-semibold ${item.quantity < 10 ? 'text-red-600' : 'text-slate-800'}">${item.quantity}</span></td>
                                <td class="px-5 py-4 bg-white text-sm text-center"><p class="text-slate-600 whitespace-no-wrap">${item.size && item.unit ? `${item.size} ${item.unit}` : 'N/A'}</p></td>
                                <td class="px-5 py-4 bg-white text-sm text-right"><p class="text-slate-900 whitespace-no-wrap font-semibold">৳${parseFloat(item.price).toFixed(2)}</p></td>
                                <td class="px-5 py-4 bg-white text-sm text-center">
                                    <div class="flex items-center justify-center space-x-2">
                                        <button data-id="${item.id}" class="sell-btn bg-green-100 text-green-700 hover:bg-green-200 text-xs font-bold py-1 px-2 rounded-md transition-colors">Sell</button>
                                        <button data-id="${item.id}" class="edit-btn text-slate-500 hover:text-indigo-600 p-1 rounded-md transition-colors" title="Edit Item">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                        </button>
                                        <button data-id="${item.id}" class="delete-btn text-slate-500 hover:text-red-600 p-1 rounded-md transition-colors" title="Delete Item">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                });
            }
            
            inventoryTableBody.innerHTML = html;
        }

        function populateCategoryFilter() {
            const categories = [...new Set(allItems.map(item => item.category))].filter(Boolean);
            const currentVal = categoryFilter.value;
            categoryFilter.innerHTML = `<option value="">All Categories</option>`;
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            categoryFilter.value = currentVal;
        }

        searchInput.addEventListener('input', renderInventory);
        categoryFilter.addEventListener('change', renderInventory);

        // --- Sales Report Logic ---
        async function fetchSalesReport() {
            if (!currentUserId) return;
            reportLoading.classList.remove('hidden');
            noSalesMessage.classList.add('hidden');
            salesReportBody.innerHTML = '';
            
            const selectedDate = new Date(reportDateInput.value);
            const startOfDay = new Date(selectedDate.setHours(0, 0, 0, 0));
            const endOfDay = new Date(selectedDate.setHours(23, 59, 59, 999));

            const q = query(salesCollectionRef, 
                where("saleDate", ">=", Timestamp.fromDate(startOfDay)),
                where("saleDate", "<=", Timestamp.fromDate(endOfDay))
            );

            try {
                onSnapshot(q, (snapshot) => {
                    dailySales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderSalesReport();
                    reportLoading.classList.add('hidden');
                    noSalesMessage.classList.toggle('hidden', dailySales.length > 0);
                });
            } catch (error) {
                console.error("Error fetching sales report:", error);
                reportLoading.classList.add('hidden');
                noSalesMessage.textContent = "Error loading report.";
                noSalesMessage.classList.remove('hidden');
            }
        }

        function renderSalesReport() {
            salesReportBody.innerHTML = '';
            dailySales.forEach(sale => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';
                row.innerHTML = `
                    <td class="px-5 py-4 bg-white text-sm">${new Date(sale.saleDate.seconds * 1000).toLocaleTimeString()}</td>
                    <td class="px-5 py-4 bg-white text-sm">${sale.itemName}</td>
                    <td class="px-5 py-4 bg-white text-sm">${sale.itemSku}</td>
                    <td class="px-5 py-4 bg-white text-sm text-center">${sale.quantitySold}</td>
                    <td class="px-5 py-4 bg-white text-sm text-right">৳${parseFloat(sale.totalPrice).toFixed(2)}</td>
                    <td class="px-5 py-4 bg-white text-sm text-center">
                        <button data-id="${sale.id}" data-itemid="${sale.inventoryItemId}" data-qty="${sale.quantitySold}" class="delete-sale-btn text-slate-500 hover:text-red-600 p-1 rounded-md transition-colors" title="Delete Sale">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                salesReportBody.appendChild(row);
            });
        }
        
        reportDateInput.addEventListener('change', fetchSalesReport);
        downloadCsvBtn.addEventListener('click', downloadCSV);

        function downloadCSV() {
            if (dailySales.length === 0) {
                showNotification("No data to download for the selected date.");
                return;
            }
            const headers = "Time,Item Name,SKU,Quantity Sold,Total Price (BDT)";
            const rows = dailySales.map(sale => [
                new Date(sale.saleDate.seconds * 1000).toLocaleTimeString(),
                `"${sale.itemName.replace(/"/g, '""')}"`,
                sale.itemSku,
                sale.quantitySold,
                sale.totalPrice.toFixed(2)
            ].join(','));
            
            const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `sales_report_${reportDateInput.value}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Event Delegation for Buttons ---
        inventoryTableBody.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            if (target.classList.contains('edit-btn')) {
                openModal('Edit Item', allItems.find(i => i.id === id));
            } else if (target.classList.contains('delete-btn')) {
                deleteItem(id);
            } else if (target.classList.contains('sell-btn')) {
                openSellModal(allItems.find(i => i.id === id));
            } else if (target.classList.contains('add-to-category-btn')) {
                const category = target.dataset.category;
                openModal('Add New Item', null, category);
            }
        });

        salesReportBody.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target || !target.classList.contains('delete-sale-btn')) return;
            deleteSaleAndRevertStock(target.dataset.id, target.dataset.itemid, parseInt(target.dataset.qty));
        });

        // --- CRUD and Sale Functions ---
        async function deleteItem(id) {
            try {
                await deleteDoc(doc(inventoryCollectionRef, id));
                showNotification("Item deleted successfully.");
            } catch (error) { 
                console.error("Error deleting item:", error); 
                showNotification("Error: Could not delete item.", 5000);
            }
        }

        async function deleteSaleAndRevertStock(saleId, inventoryItemId, quantityToRevert) {
            const inventoryItemRef = doc(inventoryCollectionRef, inventoryItemId);
            const saleRef = doc(salesCollectionRef, saleId);
            try {
                await runTransaction(db, async (transaction) => {
                    const invDoc = await transaction.get(inventoryItemRef);
                    if (!invDoc.exists()) throw "Inventory item not found!";
                    
                    const newQuantity = invDoc.data().quantity + quantityToRevert;
                    transaction.update(inventoryItemRef, { quantity: newQuantity });
                    transaction.delete(saleRef);
                });
                showNotification("Sale record deleted and stock restored.");
            } catch (error) {
                console.error("Transaction failed: ", error);
                showNotification("Failed to delete sale. The inventory item may have been deleted.", 5000);
            }
        }
        
        // --- SKU Generator ---
        function generateSku(category) {
            if (!category) return '';
            const prefix = category.trim().split(' ').map(w => w[0]).join('').toUpperCase();
            let maxNum = 0;
            allItems.forEach(item => {
                if (item.sku && item.sku.startsWith(prefix + '-')) {
                    const numPart = parseInt(item.sku.split('-')[1]);
                    if (!isNaN(numPart) && numPart > maxNum) {
                        maxNum = numPart;
                    }
                }
            });
            const newNum = (maxNum + 1).toString().padStart(3, '0');
            return `${prefix}-${newNum}`;
        }

        // --- Modal Logic ---
        const handleCategoryChangeForSku = () => {
            if (!itemIdInput.value) { // Only for new items
                itemSkuInput.value = generateSku(itemCategoryInput.value);
            }
        };
        
        function openModal(title = 'Add New Item', item = null, category = '') {
            itemModal.querySelector('#modal-title').textContent = title;
            itemForm.reset();
            itemIdInput.value = '';
            itemCategoryInput.removeEventListener('input', handleCategoryChangeForSku);

            if (item) { // Editing an existing item
                itemIdInput.value = item.id;
                itemForm.querySelector('#item-name').value = item.name;
                itemSkuInput.value = item.sku;
                itemCategoryInput.value = item.category;
                itemForm.querySelector('#item-quantity').value = item.quantity;
                itemForm.querySelector('#item-price').value = item.price;
                itemForm.querySelector('#item-size').value = item.size || '';
                itemForm.querySelector('#item-unit').value = item.unit || '';
            } else { // Adding a new item
                if (category) {
                    itemCategoryInput.value = category;
                    itemSkuInput.value = generateSku(category);
                }
                itemCategoryInput.addEventListener('input', handleCategoryChangeForSku);
            }
            itemModal.classList.remove('hidden');
            setTimeout(() => itemModal.querySelector('.modal').classList.remove('scale-95', 'opacity-0'), 10);
        }
        function closeModal() {
            itemModal.querySelector('.modal').classList.add('scale-95', 'opacity-0');
            setTimeout(() => itemModal.classList.add('hidden'), 300);
        }
        async function handleSaveItem(e) {
            e.preventDefault();
            const id = itemIdInput.value;
            const itemData = {
                name: itemForm.querySelector('#item-name').value,
                sku: itemSkuInput.value,
                category: itemForm.querySelector('#item-category').value,
                quantity: parseInt(itemForm.querySelector('#item-quantity').value),
                price: parseFloat(itemForm.querySelector('#item-price').value),
                size: itemForm.querySelector('#item-size').value,
                unit: itemForm.querySelector('#item-unit').value
            };
            
            closeModal(); // Optimistic UI: close modal immediately

            try {
                if (id) {
                    await updateDoc(doc(inventoryCollectionRef, id), itemData);
                    showNotification("Item updated successfully.");
                } else {
                    await addDoc(inventoryCollectionRef, itemData);
                    showNotification("Item added successfully.");
                }
            } catch (error) { 
                console.error("Error saving item:", error); 
                showNotification("Error: Could not save item.", 5000);
                // Note: No UI rollback needed as onSnapshot will eventually correct the view
            }
        }
        itemForm.addEventListener('submit', handleSaveItem);
        itemModal.querySelector('#cancel-btn').addEventListener('click', closeModal);
        itemModal.addEventListener('click', (e) => { if (e.target === itemModal) closeModal(); });
        addItemBtn.addEventListener('click', () => openModal());

        // Sell Item Modal
        const sellForm = document.getElementById('sell-form');
        const sellItemIdInput = document.getElementById('sell-item-id');
        function openSellModal(item) {
            if (!item || item.quantity <= 0) {
                showNotification("This item is out of stock and cannot be sold.");
                return;
            }
            sellForm.reset();
            sellItemIdInput.value = item.id;
            sellForm.querySelector('#sell-item-name').textContent = item.name;
            sellForm.querySelector('#sell-item-stock').textContent = item.quantity;
            sellForm.querySelector('#sell-quantity').max = item.quantity;
            sellModal.classList.remove('hidden');
            setTimeout(() => sellModal.querySelector('.modal').classList.remove('scale-95', 'opacity-0'), 10);
        }
        function closeSellModal() {
            sellModal.querySelector('.modal').classList.add('scale-95', 'opacity-0');
            setTimeout(() => sellModal.classList.add('hidden'), 300);
        }
        async function handleSellItem(e) {
            e.preventDefault();
            const itemId = sellItemIdInput.value;
            const quantitySold = parseInt(sellForm.querySelector('#sell-quantity').value);
            const itemRef = doc(inventoryCollectionRef, itemId);

             // --- OPTIMISTIC UI UPDATE ---
            const itemIndex = allItems.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const item = allItems[itemIndex];
                const newQuantity = item.quantity - quantitySold;
                if (newQuantity < 0) {
                    showNotification("Not enough stock to sell.");
                    return;
                }
                allItems[itemIndex].quantity = newQuantity;
                updateDashboardStats();
                renderInventory();
            }
            // --- END OPTIMISTIC UI UPDATE ---

            closeSellModal();

            try {
                await runTransaction(db, async (transaction) => {
                    const itemDoc = await transaction.get(itemRef);
                    if (!itemDoc.exists()) throw "Item does not exist!";
                    
                    const itemData = itemDoc.data();
                    const serverNewQuantity = itemData.quantity - quantitySold;
                    if (serverNewQuantity < 0) throw "Not enough stock to sell.";

                    transaction.update(itemRef, { quantity: serverNewQuantity });
                    
                    transaction.set(doc(salesCollectionRef), {
                        inventoryItemId: itemId,
                        itemName: itemData.name,
                        itemSku: itemData.sku,
                        quantitySold: quantitySold,
                        pricePerItem: itemData.price,
                        totalPrice: itemData.price * quantitySold,
                        saleDate: Timestamp.now()
                    });
                });
                showNotification("Sale recorded successfully!");
            } catch (error) {
                console.error("Sale transaction failed: ", error);
                showNotification("Error: " + error, 5000);
                // If the transaction fails, onSnapshot will eventually receive the correct data from the server
                // and revert the UI automatically, ensuring data consistency.
            }
        }
        sellForm.addEventListener('submit', handleSellItem);
        sellModal.querySelector('#cancel-sell-btn').addEventListener('click', closeSellModal);
        
        // --- Login/Signup Form Switching and Logout ---
        document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });
        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch (error) { document.getElementById('auth-error').textContent = error.message; document.getElementById('auth-error').classList.remove('hidden'); } });
        document.getElementById('signup-form').addEventListener('submit', async (e) => { e.preventDefault(); try { await createUserWithEmailAndPassword(auth, document.getElementById('signup-email').value, document.getElementById('signup-password').value); } catch (error) { document.getElementById('auth-error').textContent = error.message; document.getElementById('auth-error').classList.remove('hidden'); } });
        logoutBtn.addEventListener('click', () => signOut(auth));

    </script>
</body>
</html>
